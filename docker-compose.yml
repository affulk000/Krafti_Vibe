version: "3.8"

services:
    # PostgreSQL Database
    postgres:
        image: postgres:15-alpine
        container_name: kraftivibe-postgres
        restart: unless-stopped
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: Ecma@23#%
            POSTGRES_DB: krafti_vibe_dev
            POSTGRES_INITDB_ARGS: "-E UTF8"
            PGDATA: /var/lib/postgresql/data/pgdata
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
        networks:
            - kraftivibe-network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Redis Cache
    redis:
        image: redis:7-alpine
        container_name: kraftivibe-redis
        restart: unless-stopped
        command: redis-server --appendonly yes --requirepass redis_password
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        networks:
            - kraftivibe-network
        healthcheck:
            test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    # MinIO (S3-compatible storage for local development)
    minio:
        image: minio/minio:latest
        container_name: kraftivibe-minio
        restart: unless-stopped
        command: server /data --console-address ":9001"
        environment:
            MINIO_ROOT_USER: minioadmin
            MINIO_ROOT_PASSWORD: minioadmin
        ports:
            - "9000:9000"
            - "9001:9001"
        volumes:
            - minio_data:/data
        networks:
            - kraftivibe-network
        healthcheck:
            test:
                ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 30s
            timeout: 20s
            retries: 3

    # API Application
    api:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: kraftivibe-api
        restart: unless-stopped
        ports:
            - "3000:3000"
        environment:
            # Server
            ENV: development
            PORT: 3000
            SERVER_HOST: 0.0.0.0

            # Database
            DB_HOST: postgres
            DB_PORT: 5432
            DB_USER: postgres
            DB_PASSWORD: Ecma@23#%
            DB_NAME: krafti_vibe_dev
            DB_SSLMODE: disable
            DB_MAX_OPEN_CONNS: 25
            DB_MAX_IDLE_CONNS: 5

            # Redis
            REDIS_HOST: redis
            REDIS_PORT: 6379
            REDIS_PASSWORD: redis_password
            REDIS_DB: 0

            # Logto (Update with your Logto instance)
            LOGTO_JWKS_URI: ${LOGTO_JWKS_URI:-https://your-logto.logto.app/oidc/jwks}
            LOGTO_ISSUER: ${LOGTO_ISSUER:-https://your-logto.logto.app/oidc}
            LOGTO_API_RESOURCE: ${LOGTO_API_RESOURCE:-https://api.kraftivibe.com}

            # Application
            APP_NAME: Krafti Vibe API
            APP_VERSION: 1.0.0
            LOG_LEVEL: debug
            CORS_ORIGINS: "*"
            ENABLE_METRICS: "true"
            RATE_LIMIT_RPS: 100

            # Storage
            STORAGE_TYPE: minio
            MINIO_ENDPOINT: minio:9000
            MINIO_ACCESS_KEY: minioadmin
            MINIO_SECRET_KEY: minioadmin
            MINIO_BUCKET: kraftivibe
            MINIO_USE_SSL: "false"
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - kraftivibe-network
        volumes:
            - ./:/app
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--no-verbose",
                    "--tries=1",
                    "--spider",
                    "http://localhost:3000/health/live",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Adminer (Database Management UI)
    adminer:
        image: adminer:latest
        container_name: kraftivibe-adminer
        restart: unless-stopped
        ports:
            - "8080:8080"
        environment:
            ADMINER_DEFAULT_SERVER: postgres
            ADMINER_DESIGN: nette
        networks:
            - kraftivibe-network
        depends_on:
            - postgres

    # Redis Commander (Redis Management UI)
    redis-commander:
        image: rediscommander/redis-commander:latest
        container_name: kraftivibe-redis-commander
        restart: unless-stopped
        environment:
            REDIS_HOSTS: local:redis:6379:0:redis_password
        ports:
            - "8081:8081"
        networks:
            - kraftivibe-network
        depends_on:
            - redis

    # Mailhog (Email Testing)
    mailhog:
        image: mailhog/mailhog:latest
        container_name: kraftivibe-mailhog
        restart: unless-stopped
        ports:
            - "1025:1025" # SMTP
            - "8025:8025" # Web UI
        networks:
            - kraftivibe-network

networks:
    kraftivibe-network:
        driver: bridge
        name: kraftivibe-network

volumes:
    postgres_data:
        name: kraftivibe-postgres-data
    redis_data:
        name: kraftivibe-redis-data
    minio_data:
        name: kraftivibe-minio-data
